@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.financialdata.PeriodWithOutstandingAmount
@import utils.CurrencyFormatter.currencyFormat

@this(
        layout: templates.Layout,
        govukButton: GovukButton
)

@(
        businessName: String,
        vrn: String,
        overduePeriods: Seq[Period],
        duePeriod: Option[Period],
        duePaymentOwedPeriods: Seq[PeriodWithOutstandingAmount],
        overduePaymentOwedPeriods: Seq[PeriodWithOutstandingAmount],
        paymentError: Boolean
)(implicit request: Request[_], messages: Messages)

@layout(
    pageTitle = titleNoForm(messages("index.title")),
    showBackLink = false,
    fullWidth = true
) {

    @if(paymentError) {
        <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                @messages("notificationBanner.title")
                </h2>
            </div>
            <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                @messages("notificationBanner.text")
                </p>
            </div>
        </div>
    }

    <h1 class="govuk-heading-l">
        @messages("index.heading")
        <span class="govuk-caption-m">@businessName</span>
        <span class="govuk-caption-m">@messages("index.vrn", vrn)</span>
    </h1>

    <div class="flex-container govuk-grid-row">
        <div class="tile tile-no-border">
            <div id="next-return" class="tile-body">
                <h2 class="govuk-heading-m">@messages("index.yourReturns")</h2>


                @overduePeriods.size match {
                    case 0 => {}
                    case 1 => {
                        <p class="govuk-body">@messages("index.yourReturns.returnOverdue", overduePeriods.head.displayText)</p>
                    }
                    case x => {
                        <p class="govuk-body">@messages("index.yourReturns.returnsOverdue", x)</p>
                    }
                }

                @duePeriod match {
                    case None => {}
                    case Some(period) => {
                        <p class="govuk-body">@messages("index.yourReturns.returnDue", period.displayText, period.paymentDeadlineDisplay)</p>
                    }
                }

                @(duePeriod, overduePeriods.size) match {
                    case (None, 0) => {
                        <p class="govuk-body">@messages("index.yourReturns.nothingDue")</p>
                    }
                    case (Some(period), 0) => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@routes.StartReturnController.onPageLoad(period).url">
                            @messages("index.yourReturns.startReturn")
                            </a>
                        </p>
                    }
                    case _ => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@routes.StartReturnController.onPageLoad(overduePeriods.head).url">
                            @messages("index.yourReturns.startReturn")
                            </a>
                        </p>
                    }
                }

            </div>
        </div>

        <div class="tile tile-no-border">
            <div id="payments" class="tile-body">
                @(duePaymentOwedPeriods.size + overduePaymentOwedPeriods.size) match {
                    case 0 => {
                        <h2 class="govuk-heading-m push--top">@messages("index.payment.heading")</h2>

                        <p class="govuk-body">
                        @messages("index.payment.nothingOwed")
                        </p>
                    }
                    case _ => {
                        @if(duePaymentOwedPeriods.nonEmpty) {
                            <h2 class="govuk-heading-m push--top">@messages("index.payment.heading")</h2>
                        }
                        @for(periodWithOutstandingAmount <- duePaymentOwedPeriods) {
                            <p class="govuk-body">@Html(messages("index.payment.amountOwed", currencyFormat(periodWithOutstandingAmount.outstandingAmount), periodWithOutstandingAmount.period.displayText))</p>
                            <p class="govuk-body">
                                <a class="govuk-link" href="@routes.PaymentController.makePayment(periodWithOutstandingAmount.period, (periodWithOutstandingAmount.outstandingAmount * 100).toLong)">@messages("index.payment.makeAPayment")</a>
                            </p>
                        }
                        @if(overduePaymentOwedPeriods.nonEmpty) {
                            <h2 class="govuk-heading-m push--top">@messages("index.payment.overdueHeading")</h2>
                        }
                        @for(periodWithOutstandingAmount <- overduePaymentOwedPeriods) {
                            <p class="govuk-body">@Html(messages("index.payment.overdueAmountOwed", currencyFormat(periodWithOutstandingAmount.outstandingAmount), periodWithOutstandingAmount.period.displayText, periodWithOutstandingAmount.period.paymentDeadlineDisplay))</p>
                            <p class="govuk-body">
                                <a class="govuk-link" href="@routes.PaymentController.makePayment(periodWithOutstandingAmount.period, (periodWithOutstandingAmount.outstandingAmount * 100).toLong)">@messages("index.payment.makeAPayment")</a>
                            </p>
                        }
                    }
                }


            </div>
        </div>

        <div class="tile tile-no-border">
            <div id="history" class="tile-body">
                <h2 class="govuk-heading-m">@messages("index.history")</h2>

                <p class="govuk-body">
                    <a class="govuk-link" href="@routes.SubmittedReturnsHistoryController.onPageLoad().url">
                    @messages("index.history.previousReturns")
                    </a>
                </p>
            </div>
        </div>

    </div>


}
