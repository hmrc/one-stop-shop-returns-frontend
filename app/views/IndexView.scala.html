@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.financialdata.VatReturnWithFinancialData
@import utils.CurrencyFormatter.currencyFormat

@this(
        layout: templates.Layout,
        govukButton: GovukButton
)

@(
        businessName: String,
        vrn: String,
        overduePeriods: Seq[Period],
        duePeriod: Option[Period],
        dueVatReturnWithFinancialData: Seq[VatReturnWithFinancialData],
        overdueVatReturnWithFinancialData: Seq[VatReturnWithFinancialData],
        paymentError: Boolean
)(implicit request: Request[_], messages: Messages)

@layout(
    pageTitle = titleNoForm(messages("index.title")),
    showBackLink = false,
    fullWidth = true
) {

    @if(paymentError) {
        <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                @messages("notificationBanner.title")
                </h2>
            </div>
            <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                @messages("notificationBanner.text")
                </p>
            </div>
        </div>
    }

    <h1 class="govuk-heading-l">
        @messages("index.heading")
        <span class="govuk-caption-m">@businessName</span>
        <span class="govuk-caption-m">@messages("index.vrn", vrn)</span>
    </h1>

    <div class="flex-container govuk-grid-row">
        <div class="tile tile-no-border">
            <div id="next-return" class="tile-body">
                <h2 class="govuk-heading-m">@messages("index.yourReturns")</h2>


                @overduePeriods.size match {
                    case 0 => {}
                    case 1 => {
                        <p class="govuk-body">@messages("index.yourReturns.returnOverdue", overduePeriods.head.displayText)</p>
                    }
                    case x => {
                        <p class="govuk-body">@messages("index.yourReturns.returnsOverdue", x)</p>
                    }
                }

                @duePeriod match {
                    case None => {}
                    case Some(period) => {
                        <p class="govuk-body">@messages("index.yourReturns.returnDue", period.displayText, period.paymentDeadlineDisplay)</p>
                    }
                }

                @(duePeriod, overduePeriods.size) match {
                    case (None, 0) => {
                        <p class="govuk-body">@messages("index.yourReturns.nothingDue")</p>
                    }
                    case (Some(period), 0) => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@routes.StartReturnController.onPageLoad(period).url">
                            @messages("index.yourReturns.startReturn")
                            </a>
                        </p>
                    }
                    case _ => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@routes.StartReturnController.onPageLoad(overduePeriods.head).url">
                            @messages("index.yourReturns.startReturn")
                            </a>
                        </p>
                    }
                }

            </div>
        </div>

        <div class="tile tile-no-border">
            <div id="payments" class="tile-body">
                @(dueVatReturnWithFinancialData.size + overdueVatReturnWithFinancialData.size) match {
                    case 0 => {
                        <h2 class="govuk-heading-m push--top">@messages("index.payment.heading")</h2>

                        <p class="govuk-body">
                        @messages("index.payment.nothingOwed")
                        </p>
                    }
                    case _ => {
                        @if(dueVatReturnWithFinancialData.nonEmpty) {
                            <h2 class="govuk-heading-m push--top">@messages("index.payment.heading")</h2>
                        }
                        <div class="govuk-warning-text">
                            <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                            <strong class="govuk-warning-text__text">
                                <span class="govuk-warning-text__assistive">Warning</span>
                                @messages("index.payment.pendingPayments")
                            </strong>
                        </div>
                        @for(vatReturnWithFinancialData <- dueVatReturnWithFinancialData) {
                            @vatReturnWithFinancialData.charge match {
                                case Some(charge) => {
                                    <p class="govuk-body">
                                        @Html(messages(
                                            "index.payment.amountOwed",
                                            currencyFormat(charge.outstandingAmount),
                                            vatReturnWithFinancialData.vatReturn.period.displayText
                                        ))
                                    </p>
                                    <p class="govuk-body">
                                        <a class="govuk-link"
                                          href="@routes.PaymentController.makePayment(vatReturnWithFinancialData.vatReturn.period, (charge.outstandingAmount * 100).toLong)">
                                            @messages("index.payment.makeAPayment")
                                        </a>
                                    </p>
                                }
                                case _ => {
                                    @vatReturnWithFinancialData.vatOwed match {
                                        case Some(vatOwed) => {
                                            <p class="govuk-body">
                                                @Html(messages(
                                                    "index.payment.amountMaybeOwed",
                                                    currencyFormat(vatOwed),
                                                    vatReturnWithFinancialData.vatReturn.period.displayText
                                                ))
                                            </p>
                                            <p class="govuk-body">
                                                <a class="govuk-link"
                                                  href="@routes.PaymentController.makePayment(vatReturnWithFinancialData.vatReturn.period, vatOwed * 100L)">
                                                    @messages("index.payment.makeAPayment")
                                                </a>
                                            </p>
                                        }
                                        case _ => {
                                            <p class="govuk-body">
                                                @Html(messages(
                                                    "index.payment.amountMaybeOwed",
                                                    "money",
                                                    vatReturnWithFinancialData.vatReturn.period.displayText
                                                ))
                                            </p>
                                            <p class="govuk-body">
                                                <a class="govuk-link"
                                                  href="@routes.PaymentController.makePayment(vatReturnWithFinancialData.vatReturn.period, 0L)">
                                                    @messages("index.payment.makeAPayment")
                                                </a>
                                            </p>
                                        }
                                    }

                                }
                            }

                        }
                        @if(overdueVatReturnWithFinancialData.nonEmpty) {
                            <h2 class="govuk-heading-m push--top">@messages("index.payment.overdueHeading")</h2>
                        }
                        @for(vatReturnWithFinancialData <- overdueVatReturnWithFinancialData) {
                            @vatReturnWithFinancialData.charge match {
                                case Some(charge) => {
                                    <p class="govuk-body">
                                        @Html(messages(
                                            "index.payment.overdueAmountOwed",
                                            currencyFormat(charge.outstandingAmount),
                                            vatReturnWithFinancialData.vatReturn.period.displayText,
                                            vatReturnWithFinancialData.vatReturn.period.paymentDeadlineDisplay
                                        ))
                                    </p>
                                    <p class="govuk-body">
                                        <a class="govuk-link"
                                          href="@routes.PaymentController.makePayment(vatReturnWithFinancialData.vatReturn.period, (charge.outstandingAmount * 100).toLong)">
                                            @messages("index.payment.makeAPayment")
                                        </a>
                                    </p>
                                }
                                case _ => {
                                    @vatReturnWithFinancialData.vatOwed match {
                                        case Some(vatOwed) => {
                                            <p class="govuk-body">
                                                @Html(messages(
                                                    "index.payment.overdueMaybeAmountOwed",
                                                    currencyFormat(vatOwed),
                                                    vatReturnWithFinancialData.vatReturn.period.displayText,
                                                    vatReturnWithFinancialData.vatReturn.period.paymentDeadlineDisplay
                                                ))
                                            </p>
                                            <p class="govuk-body">
                                                <a class="govuk-link"
                                                  href="@routes.PaymentController.makePayment(vatReturnWithFinancialData.vatReturn.period, vatOwed * 100L)">
                                                    @messages("index.payment.makeAPayment")
                                                </a>
                                            </p>
                                        }
                                        case _ => {
                                            <p class="govuk-body">
                                                @Html(messages(
                                                    "index.payment.overdueMaybeAmountOwed",
                                                    "money",
                                                    vatReturnWithFinancialData.vatReturn.period.displayText,
                                                    vatReturnWithFinancialData.vatReturn.period.paymentDeadlineDisplay
                                                ))
                                            </p>
                                            <p class="govuk-body">
                                                <a class="govuk-link"
                                                  href="@routes.PaymentController.makePayment(vatReturnWithFinancialData.vatReturn.period, 0L)">
                                                    @messages("index.payment.makeAPayment")
                                                </a>
                                            </p>
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            </div>
        </div>

        <div class="tile tile-no-border">
            <div id="history" class="tile-body">
                <h2 class="govuk-heading-m">@messages("index.history")</h2>

                <p class="govuk-body">
                    <a class="govuk-link" href="@routes.SubmittedReturnsHistoryController.onPageLoad().url">
                    @messages("index.history.previousReturns")
                    </a>
                </p>
            </div>
        </div>

    </div>


}
