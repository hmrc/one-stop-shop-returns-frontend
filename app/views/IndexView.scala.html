@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.financialdata.VatReturnWithFinancialData
@import models.financialdata._
@import viewmodels.yourAccount._
@import utils.CurrencyFormatter.currencyFormat
@import java.time.format.DateTimeFormatter

@this(
        layout: templates.Layout,
        govukButton: GovukButton
)
@(
        businessName: String,
        vrn: String,
        returnsViewModel: OpenReturns,
        currentPayments: CurrentPayments,
        paymentError: Boolean
)(implicit request: Request[_], messages: Messages)

@layout(
    pageTitle = titleNoForm(messages("index.title")),
    showBackLink = false,
    fullWidth = true
) {

    @if(paymentError) {
        <div class="govuk-notification-banner" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                @messages("notificationBanner.title")
                </h2>
            </div>
            <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                @messages("notificationBanner.text")
                </p>
            </div>
        </div>
    }

    <h1 class="govuk-heading-l">
        @messages("index.heading")
        <span class="govuk-caption-m">@businessName</span>
        <span class="govuk-caption-m">@messages("index.vrn", vrn)</span>
    </h1>

    <p class="govuk-body">@messages("index.paragraph")</p>

    <div class="flex-container govuk-grid-row">
        <div class="tile tile-no-border">
            <div id="next-return" class="tile-body">
                <h2 class="govuk-heading-m">@messages("index.yourReturns")</h2>



                @(returnsViewModel.currentReturn, returnsViewModel.dueReturn, returnsViewModel.overdueReturns.size, returnsViewModel.nextReturn) match {
                    case (_, _, _, Some(nextReturn)) => {
                        <p class="govuk-body" id="next-period">@Html(messages("index.nextPeriod", nextReturn.period.displayShortText,
                            nextReturn.lastDay.plusDays(1).format(DateTimeFormatter.ofPattern("d MMMM yyyy"))))
                        </p>
                    }
                    case (None, None, 1, _) => {<p class="govuk-body">@messages("index.yourReturns.returnOverdue")</p>}
                    case (None, None, x, _) => {<p class="govuk-body">@messages("index.yourReturns.onlyReturnsOverdue", x)</p>}
                    case (Some(inProgress), None, 1, _) => {
                        <p class="govuk-body">@messages("index.yourReturns.returnOverdue.inProgress")</p>

                    }
                    case (Some(inProgress), None, x, _) => {
                        <p class="govuk-body">@messages("index.yourReturns.onlyReturnsOverdue", x)</p>
                    }

                    case (None, Some(dueReturn), 0, _) => {
                        <p class="govuk-body">@messages("index.yourReturns.returnDue", dueReturn.period.displayShortText, dueReturn.period.paymentDeadlineDisplay)</p>
                    }
                    case (None, Some(dueReturn), 1, _) => {
                        <p class="govuk-body">@messages("index.yourReturns.returnDue", dueReturn.period.displayShortText, dueReturn.period.paymentDeadlineDisplay)</p>
                        <p class="govuk-body">@messages("index.yourReturns.returnsOverdue.singular")</p>
                    }
                    case (None, Some(dueReturn), x, _) => {
                        <p class="govuk-body">@messages("index.yourReturns.returnDue", dueReturn.period.displayShortText, dueReturn.period.paymentDeadlineDisplay)</p>
                        <p class="govuk-body">@messages("index.yourReturns.returnsOverdue", x)</p>
                    }
                    case (Some(inProgress), Some(dueReturn), 0, _) => {
                        @if(dueReturn == inProgress){
                            <p class="govuk-body">@messages("index.yourReturns.inProgress", dueReturn.period.displayText)
                                <br>@messages("index.yourReturns.inProgress.due", dueReturn.period.paymentDeadlineDisplay)<br></p>
                        } else{
                            <p class="govuk-body">@messages("index.yourReturns.returnDue", dueReturn.period.displayShortText, dueReturn.period.paymentDeadlineDisplay)</p>
                            <p class="govuk-body">@messages("index.yourReturns.inProgress", inProgress.period.displayText)</p>
                        }
                    }

                    case (Some(inProgress), Some(dueReturn), 1, _) => {
                        @if(dueReturn == inProgress){
                            <p class="govuk-body">@messages("index.yourReturns.inProgress", dueReturn.period.displayText)</p>
                            <p class="govuk-body">@messages("index.yourReturns.returnOverdue")</p>
                            <p class="govuk-body">@messages("index.yourReturns.inProgress.due", dueReturn.period.paymentDeadlineDisplay)</p>
                        } else{
                            <p class="govuk-body">@messages("index.yourReturns.returnDue", dueReturn.period.displayShortText, dueReturn.period.paymentDeadlineDisplay)</p>
                            <p class="govuk-body">@messages("index.yourReturns.returnOverdue.additional.inProgress")</p>
                        }
                    }

                    case (Some(inProgress), Some(dueReturn), x, _) => {
                        @if(dueReturn == inProgress){
                            <p class="govuk-body">@messages("index.yourReturns.inProgress", dueReturn.period.displayText)</p>
                            <p class="govuk-body">@messages("index.yourReturns.returnsOverdue", x)</p>
                            <p class="govuk-body">@messages("index.yourReturns.inProgress.due", dueReturn.period.paymentDeadlineDisplay)</p>
                        } else{
                            <p class="govuk-body">@messages("index.yourReturns.returnDue", dueReturn.period.displayShortText, dueReturn.period.paymentDeadlineDisplay)</p>
                            <p class="govuk-body">@messages("index.yourReturns.returnsOverdue", x)</p>
                        }
                    }

                }

                @(returnsViewModel.currentReturn, returnsViewModel.dueReturn, returnsViewModel.overdueReturns.size) match {
                    case (Some(inProgress), Some(dueReturn), 0) => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@controllers.routes.ContinueReturnController.onPageLoad(inProgress.period).url" id="continue-your-return">
                            @messages("index.yourReturns.dueReturn.continueReturn")
                            </a>
                        </p>
                    }
                    case (Some(inProgress), _, _) => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@controllers.routes.ContinueReturnController.onPageLoad(inProgress.period).url" id="continue-your-return">
                            @messages("index.yourReturns.continueReturn", inProgress.period.displayShortText)
                            </a>
                        </p>
                    }
                    case (None, Some(dueReturn), 0) => {
                        <p class="govuk-body">
                            <a class="govuk-link" href="@routes.StartReturnController.onPageLoad(dueReturn.period).url" id="start-your-return">
                            @messages("index.yourReturns.dueReturn.startReturn")
                            </a>
                        </p>
                    }
                    case _ => {
                        @if(returnsViewModel.overdueReturns.nonEmpty) {
                            <p class="govuk-body">
                                <a class="govuk-link" href="@routes.StartReturnController.onPageLoad(returnsViewModel.overdueReturns.head.period).url" id="start-your-return">
                                @messages("index.yourReturns.startReturn", returnsViewModel.overdueReturns.head.period.displayShortText)
                                </a>
                            </p>
                        }
                    }
                }

            </div>
        </div>

        <div class="tile tile-no-border">
            <div id="payments" class="tile-body">
                <h2 class="govuk-heading-m push--top">@messages("index.payment.heading")</h2>
                @(currentPayments.duePayments.size + currentPayments.overduePayments.size) match {
                    case 0 => {
                        <p class="govuk-body">
                        @messages("index.payment.nothingOwed")
                        </p>
                    }
                    case _ => {
                        <div class="govuk-warning-text">
                            <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                            <strong class="govuk-warning-text__text">
                                <span class="govuk-warning-text__assistive">Warning</span>
                                @messages("index.payment.pendingPayments")
                            </strong>
                        </div>
                        @if(currentPayments.duePayments.nonEmpty) {
                            <h3 class="govuk-heading-s push--top">@messages("index.payment.dueHeading")</h3>
                        }
                        @for(payment <- currentPayments.duePayments) {
                            @payment.paymentStatus match {
                                case PaymentStatus.Unknown => {
                                    <p class="govuk-body">
                                    @Html(messages(
                                        "index.payment.amountMaybeOwed",
                                        payment.period.displayText,
                                        payment.period.paymentDeadlineDisplay
                                    ))
                                    </p>
                                }
                                case _ => {
                                    <p class="govuk-body">
                                    @Html(messages(
                                        "index.payment.amountOwed",
                                        currencyFormat(payment.amountOwed),
                                        payment.period.displayText,
                                        payment.period.paymentDeadlineDisplay
                                    ))
                                    </p>
                                }
                            }
                        }
                        @if(currentPayments.overduePayments.nonEmpty) {
                            <h3 class="govuk-heading-s push--top">@messages("index.payment.overdueHeading")</h3>
                        }
                        @for(payment <- currentPayments.overduePayments) {
                            @payment.paymentStatus match {
                                case PaymentStatus.Unknown => {
                                    <p class="govuk-body">
                                    @Html(messages(
                                        "index.payment.overdueAmountMaybeOwed",
                                        payment.period.displayText,
                                        payment.period.paymentDeadlineDisplay
                                    ))
                                    </p>
                                }
                                case _ => {
                                    <p class="govuk-body">
                                    @Html(messages(
                                        "index.payment.overdueAmountOwed",
                                        currencyFormat(payment.amountOwed),
                                        payment.period.displayText,
                                        payment.period.paymentDeadlineDisplay
                                    ))
                                    </p>
                                }
                            }
                        }

                        <p class="govuk-body">
                            <a class="govuk-link"
                            href="@routes.WhichVatPeriodToPayController.onPageLoad()" id="make-a-payment">
                            @messages("index.payment.makeAPayment")
                            </a>
                        </p>
                    }
                }
            </div>
        </div>

        <div class="tile tile-no-border">
            <div id="history" class="tile-body">
                <h2 class="govuk-heading-m">@messages("index.history")</h2>

                <p class="govuk-body">
                    <a class="govuk-link" href="@routes.SubmittedReturnsHistoryController.onPageLoad().url" id="view-past-returns">
                    @messages("index.history.previousReturns")
                    </a>
                </p>
            </div>
        </div>
    </div>


}
